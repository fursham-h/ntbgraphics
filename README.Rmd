---
title: "ReadMe for ntbgraphics"
last updated: 02/11/2020
output:
  rmarkdown::github_document
---

## Introduction

This package includes functions for importing, transforming and visualization of NTB datasets:

  - '*getexpdata*' for import of the Animal List (containing animal RFIDs, corresponding Genotypes and optionally Environment) and Meta Behavior (containing animals and their behavioral measures) as well as formal preparation;
  - '*ploteachexp*' for plotting of given experiments as boxplots and exporting the result as a PDF file;
  - '*loopplotexp*' for plotting all experiments within a dataset as boxplots and exporting the results in one PDF file;
  - '*heatmapexp*' for plotting all experiments as a heatmap and producing a datamatrix with z-scored values;
  - '*pcatsneexp*' for PCA and tSNE results and cluster plots.
  
## Basic Principles of Functions and Dependences
  
All functions take a **directory** as their input, which specifies the location of the **two files** "Animal List.xlsx" and "Meta Behavior.xlsx" (mind correct spelling of these files - functions rely on specific names!). 
It is also important that you mind correct **formatting** of your excel files. This includes:

  - at least two columns with information about 'RFID' and 'Genotype'/'Environmental'[Condition]/'Treatment' in your Animal List with these exact titles;
  - at least two columns with information about 'Animal', and at least one behavioral test in your Meta Behavior with exact titles:
  "Animal" "Meanspeed" "Rotations" "Center"	"Alternations" "Choices" "Context" "Cue" "FreezeBase" "Timeimmobile" "Baseline"	"inhibition70" "inhibition75" "inhibition80" "SucPref" "PlacePref" "ReversalLearn" "Activity" "Nocturnal" "SerialLearn"
  (-> this is the current entity of all available experiment names for plotting; if you need to add more
  experiments to this list, please refer to the creator of package)
\   

Further aspects can be customized depending on the specific function within that function.

All functions externally work on their own, which means that they may rely internally on one of the other functions of the package without the user needing to run them in advance.  
 
## Examples

The following plot shows the general layout you can expect from the boxplot functions ('ploteachexp' and 'loopplotexp').
\   

``` {r echo=FALSE, message=FALSE, warning=FALSE}

library(ntbgraphics)

meta.data = read_excel("/Users/paul/Documents/Github_Repo/ntbgraphics/inst/extdata/Meta Behavior.xlsx")
animal.list = read_excel("/Users/paul/Documents/Github_Repo/ntbgraphics/inst/extdata/Animal List.xlsx")

data.animal.joined = animal.list %>%
  filter(Genotype!= 'NA') %>%
  unite(col="GT_Env", Genotype, Environmental, sep= "_", remove = FALSE) %>%
  left_join(meta.data, by = c("RFID" = "Animal")) %>%
  dplyr::mutate_at(vars(Meanspeed:SerialLearn),(funs(as.numeric))) %>%
  select(RFID, GT_Env, Meanspeed:SerialLearn)

data.animal.joined$GT_Env <- factor(data.animal.joined$GT_Env, levels = c("wt_hc", "wt_sd",
                                                                          "tg_hc", "tg_sd"))

ymin = min(data.animal.joined$Meanspeed, na.rm = TRUE)*0.25
ymax = max(data.animal.joined$Meanspeed, na.rm = TRUE)*1.25

ggplot(data.animal.joined, aes_string(x="GT_Env", y="Meanspeed", fill="GT_Env")) +

  geom_boxplot(alpha = 0.4) +
  
  scale_fill_manual(values=c("#F7FCFD", "#CCECE6", "#238B45", "#00441B")) +
  scale_color_manual(values=c("#F7FCFD", "#CCECE6", "#238B45", "#00441B")) +

  geom_point(pch = 21, stroke=0.93, position = position_jitterdodge()) +

  ylab("MeanspeedScore") +
  xlab("Conditions") +

  coord_cartesian(ylim=c(ymin, ymax)) +

  geom_signif(test = "t.test",  
           comparisons = list(c(1, 2),
                              c(3, 4),
                              c(2, 3),
                              c(2, 4)), 
           y=c(0.85*ymax, 0.85*ymax, 0.89*ymax, 0.95*ymax), 
           map_signif_level = c("***"=0.001, "**"=0.01, "*"=0.05), 
           textsize = 5,  tip_length = 0.005) +

  ggtitle("Meanspeed") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(plot.title = element_text(size = 16)) +
  theme(panel.grid.major = element_blank(),
    panel.border = element_blank(),
    panel.grid.minor = element_blank(),
    legend.key = element_blank(),
    strip.background = element_blank(),
    
    axis.line.y = element_line(colour = "black", size=0.6),
    axis.ticks.x = element_blank(),
    axis.text.x = element_text(angle=0, size=10),
    axis.text.y = element_text(angle=0, size=10),
    text = element_text(size=14),
    
    legend.text = element_text(size=9),
    legend.title = element_text(size=12))
```
\
\
\   

The following map shows the general layout you can expect from the 'heatmapexp' function (please note: random data; therefore most likely no convincing clustering).
\   

``` {r echo=FALSE, message=FALSE, warning=FALSE}

library(ntbgraphics)

a <- heatmapexp(directory = paste0(system.file("extdata", package = "ntbgraphics",
                                                                mustWork = T),"/"),
                                 analysis = "4arm",
                                 title = "Example Data Heatmap")
```
\
\
\   

The following maps show the general layout you can expect from the 'pcatsneexp' function (please note: random data; therefore most likely no convincing clustering).
\   

``` {r echo=FALSE, message=FALSE, warning=FALSE}

b <- pcatsneexp(directory = paste0(system.file("extdata/", package = "ntbgraphics", mustWork = T),"/"),
           analysis = "4arm",
           perplex =  10,
           theta = 0.8,
           pastetitle = "Example PCA",
           pastetitle2 = "Example tSNE")
```

## Installation

If you want to install this package, the following lines of code provide a simple way that does not rely on any dependencies except from you having installed R and a GUI of your choice, e.g. RStudio. You may copy all of the lines in the following paragraph or skip certain lines if redundant.

``` {r eval=FALSE}

## install package devtools to get - amongst others - functions to access ntbgraphics 
## (and every other package on GitHub)
install.packages("devtools")
## load package devtools
library(devtools)
## install ntbgraphics with function 'install_github' from package devtools
install_github("volkmannp/ntbgraphics")
## that is it!

## you are now ready to use ntbgraphics on your computer and may load it using...
library(ntbgraphics)
## for examples on how to use the functions, read on below
```

For your information: You can use the command 'install.packages' for the installation of devtools due to its availability on CRAN (Comprehensive R Archive Network). Since ntbgraphics is not part of CRAN, its installation needs another function ('install_github') that in turn is part of the devtools package.

## Demo

After installing ntbgraphics, you probably want to explore the package with some random data or might simply be curious how to specifically deal with the functions provided. Thus, below you may find some lines of code that address this inquisitiveness. 
\   

The example data used for the following is provided within the package by being included in the installed files.
You may simply copy all lines and run them at once or copy indivdual lines/functions you have a particular interest in.
\   

Note: Each function works independently of what you may have run in advance as long as ntbgraphics has been loaded. Although the example shows the 'getexpdata' function as its very first, running it is not necessary for the other functions to work. This holds true for every single function!
\   
Also note that the directory within these lines aims for working on every computer by accessing the data provided within the package. If you want to work using your own files and directories, they might rather look like this: "/Users/user/Documents/experiments/ntb/run1"

``` {r eval=FALSE}

## clear workspace and load libraries (and functions)
rm(list = ls(all.names = TRUE))
library(ntbgraphics)

## (getexpdata) get modified table with data
data.animal.joined <- getexpdata(directory = paste0(system.file("extdata/", package = "ntbgraphics", 
                                                                mustWork = T),"/"), 
                                 analysis = "4arm_sd_tg",
                                 ordercolumns = "ntb",
                                 #ordercolumns = "manual", 
                                 #ordercolumns_manual = c("Center", "SerialLearn", "Meanspeed"),
                                 exclude.animals = c("900200000099671", "900200000099583"),
                                 orderlevelcond = "gtblock",
                                 acceptable.nas = 1)

## (ploteachexp) plot a defined experiment
ploteachexp(expname = "Meanspeed",
            directory = paste0(system.file("extdata", package = "ntbgraphics", mustWork = T),"/"),
            analysis = "4arm_sd_tg",
            orderlevelcond = "etblock",
          # saveplotdir = paste0(system.file("extdata", package = "ntbgraphics", mustWork = T),"/"),
            saveplotdir = FALSE)



## (loopplotexp) plot all experiments
loopplotexp(directory = paste0(system.file("extdata", package = "ntbgraphics", mustWork = T),"/"),
            analysis = "4arm",
            orderplots = "tcf4")

## (heatmapexp) print out heatmap
data.animal.matrix <- heatmapexp(directory = paste0(system.file("extdata", package = "ntbgraphics",
                                                                mustWork = T),"/"),
                                 analysis = "4arm_sd_tg",
                                 ordercolumns = "ntb",
                              #  ordercolumns_manual = 
                                 exclude.animals = FALSE,
                                 orderlevelcond = "gtblock",
                                 return.matrix.mean = FALSE,
                                 naomit = TRUE,
                                 directional = FALSE,
                                 absoluteval = FALSE,
                                 clustercols = TRUE,
                                 clusterrows = TRUE,
                                 colorbrewname = "Greys",
                                 title = "Example Data Heatmap")

## (pcatsneexp) plot PCA and tSNE
results <- pcatsneexp(directory = paste0(system.file("extdata/", package = "ntbgraphics", 
                                                     mustWork = T),"/"),
                      analysis = "4arm",
                      perplex =  10,
                      theta = 0.8,
                      pastetitle = "Example PCA",
                      pastetitle2 = "Example tSNE")
### -> access results of pcatsneexp (requires to run pcatsneexp and store results as shown above)
results_pca <- results[[1]]
results_tsne <- results[[2]]

```
